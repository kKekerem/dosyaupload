<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <!-- Google OAuth için gerekli Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    script-src 'self' 'unsafe-inline' https://apis.google.com https://accounts.google.com https://www.gstatic.com;
    frame-src https://accounts.google.com https://*.googleusercontent.com;
    style-src 'self' 'unsafe-inline';
    connect-src https://www.googleapis.com https://accounts.google.com;
  ">
  <title>Google Drive Dosya Yükleme</title>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h1>Google Drive API Dosya Yükleme</h1>

  <button id="authorize_button">Google ile Giriş Yap</button>
  <button id="signout_button" style="display:none;">Çıkış Yap</button>
  <br /><br />

  <input type="file" id="file-input" />
  <button id="upload-button">Yükle</button>

  <div id="file-list"></div>

  <script>
    const CLIENT_ID = '623121601943-t5i3a29u6j75b14647fqqvaiva8iahur.apps.googleusercontent.com'; // Kendi Client ID'n
    const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly';

    let GoogleAuth;

    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    function initClient() {
      gapi.client.init({
        clientId: CLIENT_ID,
        scope: SCOPES
      }).then(() => {
        GoogleAuth = gapi.auth2.getAuthInstance();

        updateSigninStatus(GoogleAuth.isSignedIn.get());
        GoogleAuth.isSignedIn.listen(updateSigninStatus);

        document.getElementById('authorize_button').onclick = () => {
          GoogleAuth.signIn();
        };

        document.getElementById('signout_button').onclick = () => {
          GoogleAuth.signOut();
        };

        document.getElementById('upload-button').onclick = uploadFile;

        if (GoogleAuth.isSignedIn.get()) {
          listFiles();
        }
      });
    }

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        document.getElementById('authorize_button').style.display = 'none';
        document.getElementById('signout_button').style.display = 'inline-block';
        listFiles();
      } else {
        document.getElementById('authorize_button').style.display = 'inline-block';
        document.getElementById('signout_button').style.display = 'none';
        document.getElementById('file-list').innerHTML = '';
      }
    }

    function uploadFile() {
      const fileInput = document.getElementById('file-input');
      const file = fileInput.files[0];
      if (!file) {
        alert('Lütfen bir dosya seçin!');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        alert('Dosya boyutu 5MB\'ı geçemez!');
        return;
      }

      const metadata = {
        name: file.name,
        mimeType: file.type
      };

      const accessToken = GoogleAuth.currentUser.get().getAuthResponse().access_token;
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
      form.append('file', file);

      fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
        method: 'POST',
        headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
        body: form
      }).then(response => response.json())
        .then(data => {
          alert('Dosya yüklendi, dosya ID: ' + data.id);
          listFiles();
        }).catch(error => {
          alert('Yükleme hatası: ' + error.message);
        });
    }

    function listFiles() {
      if (!GoogleAuth || !GoogleAuth.isSignedIn.get()) return;

      gapi.client.drive.files.list({
        pageSize: 10,
        fields: "files(id, name, mimeType)"
      }).then(response => {
        const files = response.result.files;
        let listHtml = '<h3>Yüklenen Dosyalar</h3>';
        if (files && files.length > 0) {
          files.forEach(file => {
            listHtml += `<div style="margin-bottom:8px;">
              <strong>${file.name}</strong> (${file.mimeType}) 
              <button onclick="downloadFile('${file.id}', '${file.name}')">İndir</button>
            </div>`;
          });
        } else {
          listHtml += '<p>Dosya yok</p>';
        }
        document.getElementById('file-list').innerHTML = listHtml;
      });
    }

    function downloadFile(fileId, fileName) {
      const accessToken = GoogleAuth.currentUser.get().getAuthResponse().access_token;
      const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;

      fetch(url, {
        headers: new Headers({'Authorization': 'Bearer ' + accessToken})
      }).then(response => {
        if (!response.ok) throw new Error('İndirme başarısız');
        return response.blob();
      }).then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName || 'dosya';
        document.body.appendChild(a);
        a.click();
        a.remove();
      }).catch(err => alert(err.message));
    }

    window.onload = handleClientLoad;
  </script>
</body>
</html>
