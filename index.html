<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Google Drive Dosya YÃ¼kleme</title>

  <!-- Google API ve Google Identity Services -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #file-list div { margin-bottom: 10px; }
    button { margin: 5px; padding: 10px 15px; }
  </style>
</head>
<body>
  <h1>Google Drive - Dosya YÃ¼kleme</h1>

  <div id="g_id_signin"></div>
  <button id="auth_button">Google ile GiriÅŸ Yap</button>
  <button id="signout_button" style="display:none;">Ã‡Ä±kÄ±ÅŸ Yap</button>

  <hr />

  <input type="file" id="file-input" />
  <button id="upload-button" disabled>YÃ¼kle</button>

  <div id="file-list"></div>

  <script>
    const CLIENT_ID = '623121601943-t5i3a29u6j75b14647fqqvaiva8iahur.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly';

    let tokenClient;
    let accessToken = null;

    // YÃ¼klendiÄŸinde Google API'yi baÅŸlat
    window.onload = () => {
      gapi.load('client', async () => {
        await gapi.client.init({
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        });
        document.getElementById('auth_button').onclick = handleAuthClick;
        document.getElementById('signout_button').onclick = signOut;
        document.getElementById('upload-button').onclick = uploadFile;
      });

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp.error !== undefined) {
            alert('Hata: ' + resp.error);
            return;
          }
          accessToken = resp.access_token;
          gapi.client.setToken({ access_token: accessToken });
          document.getElementById('auth_button').style.display = 'none';
          document.getElementById('signout_button').style.display = 'inline-block';
          document.getElementById('upload-button').disabled = false;
          listFiles();
        }
      });
    };

    function handleAuthClick() {
      if (!accessToken) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        tokenClient.requestAccessToken({ prompt: '' });
      }
    }

    function signOut() {
      accessToken = null;
      gapi.client.setToken(null);
      document.getElementById('signout_button').style.display = 'none';
      document.getElementById('auth_button').style.display = 'inline-block';
      document.getElementById('upload-button').disabled = true;
      document.getElementById('file-list').innerHTML = '';
    }

    async function uploadFile() {
      const fileInput = document.getElementById('file-input');
      const file = fileInput.files[0];
      if (!file) return alert('LÃ¼tfen bir dosya seÃ§in.');
      if (file.size > 5 * 1024 * 1024) return alert('Dosya en fazla 5MB olabilir.');

      const metadata = { name: file.name, mimeType: file.type };
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', file);

      try {
        const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + accessToken },
          body: form
        });
        const data = await res.json();
        alert('YÃ¼klendi. Dosya ID: ' + data.id);
        listFiles();
      } catch (err) {
        alert('YÃ¼kleme hatasÄ±: ' + err.message);
      }
    }

    async function listFiles() {
      try {
        const response = await gapi.client.drive.files.list({
          pageSize: 10,
          fields: "files(id, name, mimeType)"
        });
        const files = response.result.files;
        let html = '<h3>YÃ¼klenen Dosyalar</h3>';
        if (!files || files.length === 0) {
          html += '<p>Dosya yok</p>';
        } else {
          files.forEach(file => {
            html += `
              <div>
                ðŸ“„ <strong>${file.name}</strong> (${file.mimeType})
                <button onclick="downloadFile('${file.id}', '${file.name}')">Ä°ndir</button>
              </div>`;
          });
        }
        document.getElementById('file-list').innerHTML = html;
      } catch (err) {
        alert('Listeleme hatasÄ±: ' + err.message);
      }
    }

    async function downloadFile(fileId, fileName) {
      try {
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
          headers: { Authorization: 'Bearer ' + accessToken }
        });
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
      } catch (err) {
        alert('Ä°ndirme hatasÄ±: ' + err.message);
      }
    }
  </script>
</body>
</html>
