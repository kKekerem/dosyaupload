<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Google Drive API - Yeni Kimlik Doğrulama</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h1>Google Drive Dosya Yükleme - Yeni Kimlik Doğrulama</h1>

  <div id="g_id_signin"></div>
  <button id="signout_button" style="display:none;">Çıkış Yap</button>

  <br/><br/>
  <input type="file" id="file-input" />
  <button id="upload-button" disabled>Yükle</button>

  <div id="file-list"></div>

  <script>
    const CLIENT_ID = '623121601943-t5i3a29u6j75b14647fqqvaiva8iahur.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly';

    let tokenClient;
    let accessToken = null;

    // Google API yüklendiğinde init et
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: '', // API Key is optional here if you use OAuth
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
      });
      document.getElementById('upload-button').disabled = true;
    }

    // Google Identity Services OAuth Client oluştur
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // callback işlemi daha sonra handleAuthResponse ile yapılacak
      });
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw (resp);
        }
        accessToken = resp.access_token;
        gapi.client.setToken({ access_token: accessToken });
        document.getElementById('signout_button').style.display = 'inline-block';
        document.getElementById('upload-button').disabled = false;
        listFiles();
      };

      if (accessToken === null) {
        // İlk kez token isteniyor
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        // Token varsa refresh
        tokenClient.requestAccessToken({ prompt: '' });
      }
    }

    function signOut() {
      accessToken = null;
      gapi.client.setToken(null);
      document.getElementById('signout_button').style.display = 'none';
      document.getElementById('upload-button').disabled = true;
      document.getElementById('file-list').innerHTML = '';
    }

    async function uploadFile() {
      const fileInput = document.getElementById('file-input');
      const file = fileInput.files[0];
      if (!file) {
        alert('Lütfen bir dosya seçin!');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        alert('Dosya boyutu 5MB\'ı geçemez!');
        return;
      }

      const metadata = {
        name: file.name,
        mimeType: file.type
      };

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', file);

      try {
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + accessToken
          },
          body: form
        });
        const data = await response.json();
        alert('Dosya yüklendi, dosya ID: ' + data.id);
        listFiles();
      } catch (error) {
        alert('Yükleme hatası: ' + error.message);
      }
    }

    async function listFiles() {
      if (!accessToken) return;

      const response = await gapi.client.drive.files.list({
        pageSize: 10,
        fields: "files(id, name, mimeType)"
      });

      const files = response.result.files;
      let listHtml = '<h3>Yüklenen Dosyalar</h3>';
      if (files && files.length > 0) {
        files.forEach(file => {
          listHtml += `<div style="margin-bottom:8px;">
              <strong>${file.name}</strong> (${file.mimeType}) 
              <button onclick="downloadFile('${file.id}', '${file.name}')">İndir</button>
            </div>`;
        });
      } else {
        listHtml += '<p>Dosya yok</p>';
      }
      document.getElementById('file-list').innerHTML = listHtml;
    }

    async function downloadFile(fileId, fileName) {
      try {
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
          headers: { 'Authorization': 'Bearer ' + accessToken }
        });
        if (!response.ok) throw new Error('İndirme başarısız');
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName || 'dosya';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (err) {
        alert(err.message);
      }
    }

    // Butonları bağla
    window.onload = () => {
      document.getElementById('upload-button').onclick = uploadFile;
      document.getElementById('signout_button').onclick = signOut;
      gapiLoaded();
      gisLoaded();

      // Google Sign-in butonu otomatik olarak buraya geliyor
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: (response) => {
          // Bu yeni sign-in ile kullanıcı bilgisi alabilirsin (ID token)
          console.log('Signed in:', response);
        }
      });
      google.accounts.id.renderButton(
        document.getElementById('g_id_signin'),
        { theme: 'outline', size: 'large' }
      );
    };
  </script>
</body>
</html>
